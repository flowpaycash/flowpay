<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>FLOWPay Gateway Web3 - PIX ou Cripto</title>
    <link rel="stylesheet" href="css/checkout-minimal.css">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/legacy.css">
    <!-- Font Awesome removido - usar √≠cones locais ou CSS puro -->
    
    <!-- PWA Support - Modern & Apple -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff007a">
    <meta name="msapplication-TileColor" content="#ff007a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="FLOWPay">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icons/apple-icon-180.png">
    
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="assets/splash/apple-splash-dark-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/splash/apple-splash-dark-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/splash/apple-splash-dark-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/splash/apple-splash-dark-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/splash/apple-splash-dark-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="196x196" href="assets/icons/favicon-196.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-196.png">
    <link rel="shortcut icon" href="assets/icons/favicon.ico">
    
    <!-- NEO Layout Injector - Carregar antes -->
    <script src="js/layout-injector.js"></script>
    
    <!-- Web3Auth Dependencies - Bundle local -->
</head>
<body>
    <!-- Header -->
    <header class="checkout-header">
                            <div class="hero">
                        <h1 id="hero-headline">Escolha como quer receber: PIX ou Cripto</h1>
                        <p id="hero-subheadline">Selecione seu modo preferido de recebimento</p>
                    </div>
        
        <!-- Breadcrumb Visual -->
        <div class="checkout-breadcrumb">
            <div class="breadcrumb-step" data-step="choose">
                <span class="step-number">1</span>
                <span class="step-label">Escolha</span>
            </div>
            <div class="breadcrumb-arrow">‚Üí</div>
            <div class="breadcrumb-step" data-step="details">
                <span class="step-number">2</span>
                <span class="step-label">Detalhes</span>
            </div>
            <div class="breadcrumb-arrow">‚Üí</div>
            <div class="breadcrumb-step" data-step="confirm">
                <span class="step-number">3</span>
                <span class="step-label">Confirma√ß√£o</span>
            </div>
        </div>
        
        <!-- progress mountpoint (preenchido pelo JS) -->
    </header>

    <!-- Main Content -->
    <main class="checkout-main">
        <!-- STEP 0: escolher -->
        <section class="flow-step" data-state="choose" id="step-choose">
            <div class="mode-chooser">
                <button class="tab-button" data-action="select-mode" data-mode="pix">PIX</button>
                <button class="tab-button" data-action="select-mode" data-mode="crypto">Cripto</button>
                <button class="ghost" data-action="connect-wallet" id="connect-wallet-btn">Conectar carteira</button>
            </div>
        </section>

        <!-- STEP 1: detalhes -->
        <section class="flow-step" data-state="details" id="step-details" hidden>
            <!-- PIX -->
            <section id="pix-mode" class="mode-section">
                <form id="pix-form" class="card">
                    <div class="grid">
                        <label>Wallet (refer√™ncia interna)
                            <input name="wallet" id="wallet" placeholder="0x..." autocomplete="off" />
                        </label>
                        <label>Valor
                            <input name="valor" id="valor" type="number" step="0.01" min="0.01" placeholder="100.00" />
                        </label>
                        <label>Moeda
                            <input name="moeda" id="moeda" value="BRL" />
                        </label>
                        <input type="hidden" name="id_transacao" />
                    </div>
                    <div class="actions">
                        <button class="primary" type="submit">Gerar cobran√ßa PIX</button>
                        <button class="text" type="button" data-action="reset">Voltar</button>
                    </div>
                </form>
            </section>

            <!-- CRYPTO -->
            <section id="crypto-mode" class="mode-section" hidden>
                <form id="crypto-form" class="card">
                    <div class="grid">
                        <label>Quantidade
                            <input name="crypto-amount" id="crypto-amount" type="number" step="0.0001" min="0.0001" />
                        </label>
                        <label>Ativo
                            <input name="crypto-currency" id="crypto-currency" placeholder="ETH / USDC" />
                        </label>
                        <label>Enviar para
                            <input name="crypto-to" id="crypto-to" placeholder="0x..." />
                        </label>
                    </div>
                    <div class="actions">
                        <button class="primary" type="submit">Receber em Cripto</button>
                        <button class="text" type="button" data-action="reset">Voltar</button>
                    </div>
                </form>
            </section>
        </section>

        <!-- STEP 2: confirma√ß√£o -->
        <section class="flow-step" data-state="confirm" id="step-confirm" hidden>
            <div class="card success">
                <h3>Pagamento em processamento</h3>
                <p>Registrando prova e atualizando status‚Ä¶</p>
                <ul id="footnote" class="foot"></ul>
                <div class="actions">
                    <a class="primary" href="/transparency">Ver transpar√™ncia</a>
                    <button class="text" data-action="reset">Iniciar novo fluxo</button>
                </div>
            </div>
        </section>
    </main>

    <!-- holders do overlay/toasts -->
    <div id="nf-loading" class="nf-loading" style="display:none">
        <div class="nf-card"><div class="nf-spinner" aria-hidden="true"></div><p class="nf-title">Carregando‚Ä¶</p></div>
    </div>
    <div id="nf-toasts" class="nf-toasts"></div>

    <!-- Footer NŒû√ò -->
    <footer class="neo-footer">
        <div class="container">
            <div class="neo-footer__grid">
                <div class="neo-footer__brand">
                    <a href="/" class="neo-footer__logo">FLOWPay</a>
                    <p class="neo-footer__tag">Checkout invis√≠vel. Auto‚Äëcust√≥dia. Transparente por padr√£o.</p>
                    <a href="/transparency" class="neo-footer__pill">Ver transpar√™ncia</a>
                </div>
                
                <div class="neo-footer__col">
                    <h3>Produto</h3>
                    <ul>
                        <li><a href="/checkout">Checkout</a></li>
                        <li><a href="/transparency">Transpar√™ncia</a></li>
                        <li><a href="/admin">Admin</a></li>
                    </ul>
                </div>
                
                <div class="neo-footer__col">
                    <h3>Recursos</h3>
                    <ul>
                        <li><a href="/pix_orders.json">Transa√ß√µes PIX</a></li>
                        <li><a href="/.well-known/security.txt">Security</a></li>
                        <li><a href="https://github.com/flowpaycash/flowpay">GitHub</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="neo-footer__note">
                Sistema de pagamento descentralizado com foco em transpar√™ncia e auto‚Äëcust√≥dia.
            </div>
        </div>
        
        <div class="neo-footer__meta">
            <div class="neo-footer__meta__row">
                <p>&copy; 2024 FLOWPay. Todos os direitos reservados.</p>
                <p class="neo-footer__links">
                    <a href="https://github.com/flowpaycash/flowpay" target="_blank" rel="noopener">github</a>
                    <span>‚Ä¢</span>
                    <a href="/checkout">checkout</a>
                    <span>‚Ä¢</span>
                    <a href="/transparency">transpar√™ncia</a>
                    <span>‚Ä¢</span>
                    <a href="/client">cliente</a>
                    <span>‚Ä¢</span>
                    <a href="/admin">admin</a>
                </p>
            </div>
        </div>
    </footer>

    <!-- CSP Configuration -->
    <!-- <script src="csp-config.js"></script> -->
    
    <!-- Wallet Boot Loader NŒû√ò -->
    <script>
      (async () => {
        try {
          const r = await fetch('/.netlify/functions/neo-config', { cache:'no-store' });
          if (r.ok) window.NEO_CONFIG = await r.json();
        } catch {}
      })();
    </script>
    
    <!-- Scripts principais -->
    <script type="module" src="/assets/js/wallet.boot.js"></script>
    <script type="module" src="/assets/js/navigation-flow.machine.js"></script>
    
    <!-- Script de teste para verificar elementos -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Verificando elementos do checkout...');
            
            // Verificar se os elementos est√£o presentes
            const stepChoose = document.getElementById('step-choose');
            const modeChooser = document.querySelector('.mode-chooser');
            const pixButton = document.querySelector('[data-mode="pix"]');
            const cryptoButton = document.querySelector('[data-mode="crypto"]');
            const connectButton = document.getElementById('connect-wallet-btn');
            
            console.log('üìã Elementos encontrados:', {
                stepChoose: !!stepChoose,
                modeChooser: !!modeChooser,
                pixButton: !!pixButton,
                cryptoButton: !!cryptoButton,
                connectButton: !!connectButton
            });
            
            // Verificar se est√£o vis√≠veis
            if (stepChoose) {
                console.log('üëÅÔ∏è Step Choose vis√≠vel:', !stepChoose.hidden);
                console.log('üé® Step Choose display:', window.getComputedStyle(stepChoose).display);
            }
            
            // For√ßar visibilidade se necess√°rio
            if (stepChoose && stepChoose.hidden) {
                stepChoose.hidden = false;
                console.log('‚úÖ Step Choose for√ßado a ser vis√≠vel');
            }
            
            // Verificar se a m√°quina de estados est√° funcionando
            setTimeout(() => {
                if (window.machineService) {
                    console.log('‚úÖ M√°quina de estados funcionando:', window.machineService.state.value);
                } else {
                    console.log('‚ùå M√°quina de estados n√£o encontrada');
                    // For√ßar inicializa√ß√£o manual
                    forceCheckoutInit();
                }
            }, 1000);
        });
        
        // Fun√ß√£o de fallback para inicializar checkout
        function forceCheckoutInit() {
            console.log('üöÄ Inicializando checkout manualmente...');
            
            // FOR√áAR VISIBILIDADE DO TEXTO HERO
            const heroHeadline = document.getElementById('hero-headline');
            const heroSubheadline = document.getElementById('hero-subheadline');
            
            if (heroHeadline) {
                heroHeadline.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    color: #ff007a !important;
                    font-size: 2.5rem !important;
                    font-weight: 700 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                `;
                console.log('‚úÖ Hero headline for√ßado a ser vis√≠vel');
            }
            
            if (heroSubheadline) {
                heroSubheadline.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    color: rgba(255, 255, 255, 0.8) !important;
                    font-size: 1.2rem !important;
                    margin: 1rem 0 0 0 !important;
                    padding: 0 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                `;
                console.log('‚úÖ Hero subheadline for√ßado a ser vis√≠vel');
            }
            
            // Mostrar step inicial
            const stepChoose = document.getElementById('step-choose');
            if (stepChoose) {
                stepChoose.hidden = false;
                stepChoose.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                    margin: 0 !important;
                    padding: 0.5rem 1rem !important;
                `;
                console.log('‚úÖ Step choose for√ßado a ser vis√≠vel');
            }
            
            // FOR√áAR VISIBILIDADE DOS BOT√ïES
            const modeChooser = document.querySelector('.mode-chooser');
            if (modeChooser) {
                modeChooser.style.cssText = `
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    gap: 0.5rem !important;
                    flex-direction: column !important;
                `;
                console.log('‚úÖ Mode chooser for√ßado a ser vis√≠vel');
            }
            
            // Adicionar event listeners aos bot√µes
            const pixButton = document.querySelector('[data-mode="pix"]');
            const cryptoButton = document.querySelector('[data-mode="crypto"]');
            const connectButton = document.getElementById('connect-wallet-btn');
            
            if (pixButton) {
                pixButton.style.cssText = `
                    display: inline-block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                    background: linear-gradient(45deg, #00d4ff, #0099cc) !important;
                    color: white !important;
                    border: none !important;
                    padding: 1.5rem 2rem !important;
                    border-radius: 12px !important;
                    font-size: 1.2rem !important;
                    font-weight: 600 !important;
                    cursor: pointer !important;
                    margin: 0.5rem 0 !important;
                `;
                console.log('‚úÖ Bot√£o PIX for√ßado a ser vis√≠vel');
            }
            
            if (cryptoButton) {
                cryptoButton.style.cssText = `
                    display: inline-block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                    background: linear-gradient(45deg, #ff007a, #cc005e) !important;
                    color: white !important;
                    border: none !important;
                    padding: 1.5rem 2rem !important;
                    border-radius: 12px !important;
                    font-size: 1.2rem !important;
                    font-weight: 600 !important;
                    cursor: pointer !important;
                    margin: 0.5rem 0 !important;
                `;
                console.log('‚úÖ Bot√£o Cripto for√ßado a ser vis√≠vel');
            }
            
            if (connectButton) {
                connectButton.style.cssText = `
                    display: inline-block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 9999 !important;
                    background: transparent !important;
                    color: rgba(255, 255, 255, 0.8) !important;
                    border: 2px solid rgba(255, 255, 255, 0.3) !important;
                    padding: 1rem 2rem !important;
                    border-radius: 12px !important;
                    font-size: 1rem !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    margin: 0.5rem 0 !important;
                `;
                console.log('‚úÖ Bot√£o Conectar carteira for√ßado a ser vis√≠vel');
            }
            
            // Adicionar event listeners
            if (pixButton) {
                pixButton.addEventListener('click', () => {
                    console.log('üéØ PIX selecionado');
                    window.navigateToStep('details', 'pix');
                });
            }
            
            if (cryptoButton) {
                cryptoButton.addEventListener('click', () => {
                    console.log('üéØ Cripto selecionado');
                    window.navigateToStep('details', 'crypto');
                });
            }
            
            if (connectButton) {
                connectButton.addEventListener('click', () => {
                    console.log('üéØ Conectando carteira...');
                    // Aqui voc√™ pode adicionar l√≥gica de conex√£o
                    window.showToast('Conectando carteira...', 'info');
                });
            }
            
            // Fun√ß√£o para navegar entre steps
            window.navigateToStep = function(step, mode = null) {
                console.log(`üöÄ Navegando para step: ${step}, mode: ${mode}`);
                
                // Esconder todos os steps
                document.querySelectorAll('.flow-step').forEach(s => s.hidden = true);
                
                // Mostrar step desejado
                const targetStep = document.getElementById(`step-${step}`);
                if (targetStep) {
                    targetStep.hidden = false;
                    console.log(`‚úÖ Step ${step} vis√≠vel`);
                }
                
                // Configurar modo espec√≠fico se necess√°rio
                if (step === 'details' && mode) {
                    if (mode === 'pix') {
                        document.getElementById('pix-mode').hidden = false;
                        document.getElementById('crypto-mode').hidden = true;
                        console.log('‚úÖ Modo PIX ativado');
                    } else if (mode === 'crypto') {
                        document.getElementById('pix-mode').hidden = true;
                        document.getElementById('crypto-mode').hidden = false;
                        console.log('‚úÖ Modo Cripto ativado');
                    }
                }
                
                // Atualizar breadcrumbs
                window.updateBreadcrumbs(step);
                
                // Scroll para o topo do step
                targetStep?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };
            
            // Fun√ß√£o para atualizar breadcrumbs
            function updateBreadcrumbs(activeStep) {
                const steps = ['choose', 'details', 'confirm'];
                const activeIndex = steps.indexOf(activeStep);
                
                document.querySelectorAll('.breadcrumb-step').forEach((step, index) => {
                    const stepName = step.dataset.step;
                    const stepIndex = steps.indexOf(stepName);
                    
                    step.classList.remove('is-active', 'is-done', 'is-pending');
                    
                    if (stepIndex === activeIndex) {
                        step.classList.add('is-active');
                    } else if (stepIndex < activeIndex) {
                        step.classList.add('is-done');
                    } else {
                        step.classList.add('is-pending');
                    }
                });
                
                console.log(`üéØ Breadcrumbs atualizados para step: ${activeStep}`);
            }
            
            // Fun√ß√£o para mostrar toasts
            function showToast(message, type = 'info') {
                let holder = document.getElementById('nf-toasts');
                if (!holder) {
                    holder = document.createElement('div');
                    holder.id = 'nf-toasts';
                    holder.className = 'nf-toasts';
                    document.body.appendChild(holder);
                }
                
                const toast = document.createElement('div');
                toast.className = `nf-toast is-${type}`;
                toast.innerHTML = `<span>${message}</span><button class="nf-x" aria-label="Fechar">√ó</button>`;
                holder.appendChild(toast);
                
                toast.querySelector('.nf-x').onclick = () => toast.remove();
                setTimeout(() => toast.remove(), 4200);
                
                console.log(`üçû Toast mostrado: ${message}`);
            }
            
            console.log('‚úÖ Checkout inicializado manualmente com todos os elementos for√ßados');
            
            // Adicionar event listeners para bot√µes de navega√ß√£o
            setupNavigationButtons();
        }
        
        // Fun√ß√£o para configurar bot√µes de navega√ß√£o
        function setupNavigationButtons() {
            // Bot√£o "Voltar" nos formul√°rios
            const backButtons = document.querySelectorAll('[data-action="reset"]');
            backButtons.forEach(button => {
                button.addEventListener('click', () => {
                    console.log('üîô Voltando para step inicial');
                    navigateToStep('choose');
                });
            });
            
            // Bot√£o "Iniciar novo fluxo" na confirma√ß√£o
            const resetButton = document.querySelector('[data-action="reset"]');
            if (resetButton) {
                resetButton.addEventListener('click', () => {
                    console.log('üîÑ Reiniciando fluxo');
                    navigateToStep('choose');
                });
            }
            
            // Event listeners para formul√°rios
            setupFormSubmissions();
        }
        
        // Fun√ß√£o para configurar submiss√£o de formul√°rios
        function setupFormSubmissions() {
            // Formul√°rio PIX
            const pixForm = document.getElementById('pix-form');
            if (pixForm) {
                pixForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('üìù Formul√°rio PIX submetido');
                    handlePixSubmission();
                });
            }
            
            // Formul√°rio Crypto
            const cryptoForm = document.getElementById('crypto-form');
            if (cryptoForm) {
                cryptoForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('üìù Formul√°rio Crypto submetido');
                    handleCryptoSubmission();
                });
            }
        }
        
        // Fun√ß√£o para lidar com submiss√£o PIX
        function handlePixSubmission() {
            const formData = new FormData(document.getElementById('pix-form'));
            const data = {
                wallet: formData.get('wallet'),
                valor: formData.get('valor'),
                moeda: formData.get('moeda'),
                id_transacao: formData.get('id_transacao') || `pix_${Date.now()}`
            };
            
            console.log('üí≥ Dados PIX coletados:', data);
            
            // Validar dados
            if (!data.wallet || !data.valor || !data.moeda) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            // Simular processamento
            showToast('Processando pagamento PIX...', 'info');
            
            setTimeout(() => {
                navigateToStep('confirm');
                showToast('Pagamento PIX processado com sucesso!', 'success');
            }, 2000);
        }
        
        // Fun√ß√£o para lidar com submiss√£o Crypto
        function handleCryptoSubmission() {
            const formData = new FormData(document.getElementById('crypto-form'));
            const data = {
                amount: formData.get('crypto-amount'),
                currency: formData.get('crypto-currency'),
                to: formData.get('crypto-to')
            };
            
            console.log('ü™ô Dados Crypto coletados:', data);
            
            // Validar dados
            if (!data.amount || !data.currency || !data.to) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            // Simular processamento
            showToast('Processando pagamento Crypto...', 'info');
            
            setTimeout(() => {
                navigateToStep('confirm');
                showToast('Pagamento Crypto processado com sucesso!', 'success');
            }, 2000);
        }
    </script>

    
    <!-- Scripts -->
    <script type="module">
        import { startCheckout } from '/assets/js/navigation-flow.machine.js';

        // üåü FLOWPay ‚Äî Checkout Machine
        // - M√°quina de estados XState-like
        // - Dual mode: PIX + Crypto
        // - Web3Auth integration (local bundle)
        // - Form validation & submission
        
        // üåü Initialize Checkout Machine on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ Initializing FLOWPay...");
            
            // Web3Auth j√° foi inicializado automaticamente pelo bundle
            console.log("‚úÖ Web3Auth auto-initialized");
            
            // üöÄ Initialize Checkout Machine
            console.log("üöÄ Initializing Checkout Machine...");
            
            // carrega a copy p√∫blica
            let copy = {};
            try {
                const res = await fetch('/ui.copy.pt.json', { cache: 'no-store' });
                if (res.ok) copy = await res.json();
                console.log("‚úÖ Copy loaded:", copy);
            } catch (error) {
                console.warn("‚ö†Ô∏è Copy loading failed:", error);
            }

            let svc;
            try {
                svc = startCheckout({
                    copy,
                    services: {
                        createPix:   async (ctx, p) => {
                            console.log("üîÑ Creating PIX charge via Woovi API:", p);
                            
                            try {
                                const response = await fetch('/.netlify/functions/create-pix-charge', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(p)
                                });
                                
                                const responseData = await response.json();
                                
                                if (!response.ok) {
                                    // Extrair mensagem de erro mais espec√≠fica
                                    let errorMessage = 'Erro ao criar cobran√ßa PIX';
                                    
                                    if (responseData.error) {
                                        errorMessage = responseData.error;
                                    } else if (responseData.details && responseData.details.apiError) {
                                        errorMessage = responseData.details.apiError.message || responseData.details.apiError;
                                    } else if (responseData.message) {
                                        errorMessage = responseData.message;
                                    }
                                    
                                    // Log detalhado para debug
                                    console.error("‚ùå Error creating PIX charge:", {
                                        status: response.status,
                                        statusText: response.statusText,
                                        error: errorMessage,
                                        details: responseData.details,
                                        fullResponse: responseData
                                    });
                                    
                                    const error = new Error(errorMessage);
                                    error.status = response.status;
                                    error.details = responseData.details;
                                    throw error;
                                }
                                
                                console.log("‚úÖ PIX charge created successfully:", responseData);
                                return responseData;
                            } catch (error) {
                                // Log completo do erro para debug
                                console.error("‚ùå Error creating PIX charge:", {
                                    message: error.message,
                                    status: error.status,
                                    details: error.details,
                                    stack: error.stack
                                });
                                
                                // Re-throw com mensagem amig√°vel
                                throw error;
                            }
                        },
                        submitCrypto:(ctx, p) => {
                            console.log("üîÑ Submitting crypto:", p);
                            return Promise.resolve({ success: true, hash: `0x${Math.random().toString(16).slice(2)}` });
                        },
                        connect:     () => window.connectWallet?.(),
                        disconnect:  () => window.disconnectWallet?.()
                    },
                    onToast: (msg, type) => {
                        let holder = document.getElementById('nf-toasts');
                        if (!holder) { holder = document.createElement('div'); holder.id='nf-toasts'; holder.className='nf-toasts'; document.body.appendChild(holder); }
                        const n = document.createElement('div');
                        n.className = `nf-toast is-${type||'info'}`;
                        n.innerHTML = `<span>${msg}</span><button class="nf-x" aria-label="Fechar">√ó</button>`;
                        holder.appendChild(n);
                        n.querySelector('.nf-x').onclick = () => n.remove();
                        setTimeout(()=>n.remove(), 4200);
                    }
                });
                
                console.log("üéØ startCheckout executado com sucesso");
            } catch (error) {
                console.error("‚ùå Erro ao executar startCheckout:", error);
                svc = null;
            }

            // progress mountpoint
            (function mountProgress(){
                const header = document.querySelector('.checkout-header');
                if (!header) return;
                const el = document.createElement('div');
                el.className = 'nf-progress';
                el.innerHTML = `<div class="nf-bar"><div class="nf-fill" id="nf-fill"></div></div>
                                <div class="nf-dots">
                                  <button class="nf-dot" data-action="goto" data-step="0" aria-label="Escolha"></button>
                                  <button class="nf-dot" data-action="goto" data-step="1" aria-label="Detalhes"></button>
                                  <button class="nf-dot" data-action="goto" data-step="2" aria-label="Confirmar"></button>
                                </div>`;
                header.appendChild(el);
            })();
            
            // Verificar se o servi√ßo foi criado com sucesso
            if (svc && typeof svc === 'object') {
                // Expor servi√ßo globalmente para debug
                window.checkoutService = svc;
                window.machineService = svc; // Dupla exposi√ß√£o para compatibilidade
                console.log("‚úÖ Checkout Machine ready!");
                console.log("üéØ Servi√ßo exposto:", svc);
                console.log("üéØ Estado atual:", svc.state);
            } else {
                console.error("‚ùå startCheckout n√£o retornou um servi√ßo v√°lido");
                console.log("üéØ Tipo de svc:", typeof svc);
                console.log("üéØ Valor de svc:", svc);
            }
            
            // Fun√ß√£o para valida√ß√£o em tempo real
            function setupRealTimeValidation() {
                const walletField = document.getElementById('wallet');
                const valorField = document.getElementById('valor');
                const cryptoAmountField = document.getElementById('crypto-amount');
                const cryptoToField = document.getElementById('crypto-to');
                
                // Valida√ß√£o do campo wallet
                if (walletField) {
                    walletField.addEventListener('input', function() {
                        const value = this.value.trim();
                        const isValid = value.length > 0 && value.startsWith('0x') && value.length === 42;
                        
                        this.classList.toggle('valid', isValid);
                        this.classList.toggle('invalid', !isValid && value.length > 0);
                        
                        // Mostrar/ocultar mensagem de erro
                        let errorMsg = this.parentNode.querySelector('.field-error');
                        if (!errorMsg && !isValid && value.length > 0) {
                            errorMsg = document.createElement('div');
                            errorMsg.className = 'field-error';
                            errorMsg.textContent = 'Wallet deve ser um endere√ßo Ethereum v√°lido (0x...)';
                            this.parentNode.appendChild(errorMsg);
                        } else if (errorMsg && isValid) {
                            errorMsg.remove();
                        }
                    });
                }
                
                // Valida√ß√£o do campo valor
                if (valorField) {
                    valorField.addEventListener('input', function() {
                        const value = parseFloat(this.value);
                        const isValid = value > 0;
                        
                        this.classList.toggle('valid', isValid);
                        this.classList.toggle('invalid', !isValid && this.value.length > 0);
                        
                        // Mostrar/ocultar mensagem de erro
                        let errorMsg = this.parentNode.querySelector('.field-error');
                        if (!errorMsg && !isValid && this.value.length > 0) {
                            errorMsg = document.createElement('div');
                            errorMsg.className = 'field-error';
                            errorMsg.textContent = 'Valor deve ser maior que zero';
                            this.parentNode.appendChild(errorMsg);
                        } else if (errorMsg && isValid) {
                            errorMsg.remove();
                        }
                    });
                }
                
                // Valida√ß√£o dos campos crypto
                if (cryptoAmountField) {
                    cryptoAmountField.addEventListener('input', function() {
                        const value = parseFloat(this.value);
                        const isValid = value > 0;
                        
                        this.classList.toggle('valid', isValid);
                        this.classList.toggle('invalid', !isValid && this.value.length > 0);
                    });
                }
                
                if (cryptoToField) {
                    cryptoToField.addEventListener('input', function() {
                        const value = this.value.trim();
                        const isValid = value.length > 0 && value.startsWith('0x') && value.length === 42;
                        
                        this.classList.toggle('valid', isValid);
                        this.classList.toggle('invalid', !isValid && value.length > 0);
                    });
                }
            }
            
            // Fun√ß√£o para navega√ß√£o por teclado
            function setupKeyboardNavigation() {
                // Navega√ß√£o com Tab
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.matches('input')) {
                        e.preventDefault();
                        
                        // Encontrar o pr√≥ximo campo ou submeter o formul√°rio
                        const currentForm = e.target.closest('form');
                        if (currentForm) {
                            const inputs = Array.from(currentForm.querySelectorAll('input'));
                            const currentIndex = inputs.indexOf(e.target);
                            
                            if (currentIndex < inputs.length - 1) {
                                // Ir para o pr√≥ximo campo
                                inputs[currentIndex + 1].focus();
                            } else {
                                // √öltimo campo - submeter formul√°rio
                                currentForm.requestSubmit();
                            }
                        }
                    }
                    
                    // Navega√ß√£o com setas
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        const inputs = Array.from(document.querySelectorAll('input:not([type="hidden"])'));
                        const currentIndex = inputs.indexOf(document.activeElement);
                        
                        if (e.key === 'ArrowDown' && currentIndex < inputs.length - 1) {
                            inputs[currentIndex + 1].focus();
                        } else if (e.key === 'ArrowUp' && currentIndex > 0) {
                            inputs[currentIndex - 1].focus();
                        }
                    }
                });
            }
            
            // Preencher ID da transa√ß√£o automaticamente
            const idField = document.getElementById('id_transacao');
            if (idField) {
                idField.value = `pix_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
            }
            
            // Auto-focus no primeiro campo
            const walletField = document.getElementById('wallet');
            if (walletField) walletField.focus();
            
            // Valida√ß√£o em tempo real
            setupRealTimeValidation();
            
            // Navega√ß√£o por teclado
            setupKeyboardNavigation();
        });
    </script>
</body>
</html>
