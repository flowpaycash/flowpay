import{a as se}from"./chunk-NJS66JOX.js";import{a as c,b as O,f as Ie,h as x,i as ee,k as C,l as te,m as oe}from"./chunk-W44JATXS.js";import"./chunk-BXV67TBK.js";import"./chunk-E62CRSR5.js";import"./chunk-5XACWPQJ.js";import{e as P,g as Me}from"./chunk-BG6P72OF.js";var A={};P(A,{TRANSACTION_SETTINGS:()=>T,averageResponseTime:()=>He,canBeUsed:()=>We,cleanOldMessages:()=>fe,close:()=>Ve,commitIndexedDBTransaction:()=>M,create:()=>Ue,createDatabase:()=>ce,getAllMessages:()=>Be,getIdb:()=>V,getMessagesHigherThan:()=>de,getOldMessages:()=>me,microSeconds:()=>De,onMessage:()=>Ye,postMessage:()=>$e,removeMessagesById:()=>le,type:()=>xe,writeMessage:()=>ue});var re=Me(Ie());function ne(e){return!!(e&&typeof e.then=="function")}Promise.resolve(!1);Promise.resolve(!0);var h=Promise.resolve();function b(e,t){return e||(e=0),new Promise(s=>{setTimeout(()=>s(t),e)})}function ie(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function _(){return Math.random().toString(36).substring(2)}var B=0;function m(){let e=Date.now()*1e3;return e<=B&&(e=B+1),B=e,e}var l=re.default.getLogger("broadcast-channel");l.setLevel("error");var S=class{ttl;map=new Map;_to=!1;constructor(t){this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,ae()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Ne(this)},0))}clear(){this.map.clear()}};function Ne(e){let t=ae()-e.ttl,s=e.map[Symbol.iterator]();for(;;){let o=s.next().value;if(!o)return;let r=o[0];if(o[1]<t)e.map.delete(r);else return}}function ae(){return Date.now()}var a={MAINNET:"mainnet",TESTNET:"testnet",CYAN:"cyan",AQUA:"aqua",CELESTE:"celeste"},w={SAPPHIRE_DEVNET:"sapphire_devnet",SAPPHIRE_MAINNET:"sapphire_mainnet"},Ce={[a.MAINNET]:"0xf20336e16B5182637f09821c27BDe29b0AFcfe80",[a.TESTNET]:"0xd084604e5FA387FbC2Da8bAab07fDD6aDED4614A",[a.CYAN]:"0x9f072ba19b3370e512aa1b4bfcdaf97283168005",[a.AQUA]:"0x29Dea82a0509153b91040ee13cDBba0f03efb625",[a.CELESTE]:"0x6Bffb4e89453069E7487f0fa5c9f4a2D771cce6c"};var Ae={[a.AQUA]:{migrationCompleted:!0,networkIdentifier:"aqua",networkMigratedTo:w.SAPPHIRE_MAINNET},[a.CELESTE]:{migrationCompleted:!0,networkIdentifier:"celeste",networkMigratedTo:w.SAPPHIRE_MAINNET},[a.CYAN]:{migrationCompleted:!0,networkIdentifier:"cyan",networkMigratedTo:w.SAPPHIRE_MAINNET},[a.MAINNET]:{migrationCompleted:!0,networkIdentifier:"mainnet",networkMigratedTo:w.SAPPHIRE_MAINNET},[a.TESTNET]:{migrationCompleted:!0,networkIdentifier:"teal",networkMigratedTo:w.SAPPHIRE_DEVNET}},ke={[a.MAINNET]:"mainnet",[a.TESTNET]:"goerli",[a.CYAN]:"polygon-mainnet",[a.AQUA]:"polygon-mainnet",[a.CELESTE]:"polygon-mainnet"},Re={[w.SAPPHIRE_MAINNET]:"https://api.web3auth.io/signer-service",[w.SAPPHIRE_DEVNET]:"https://api.web3auth.io/signer-service",[a.MAINNET]:"https://api.web3auth.io/signer-service",[a.TESTNET]:"https://api.web3auth.io/signer-service",[a.CYAN]:"https://api.web3auth.io/signer-polygon-service",[a.AQUA]:"https://api.web3auth.io/signer-polygon-service",[a.CELESTE]:"https://api.web3auth.io/signer-polygon-service"},Le={[a.MAINNET]:"https://api.web3auth.io/metadata-service",[a.TESTNET]:"https://api.web3auth.io/metadata-service",[a.CYAN]:"https://api.web3auth.io/metadata-service",[a.AQUA]:"https://api.web3auth.io/metadata-service",[a.CELESTE]:"https://api.web3auth.io/metadata-service"};var U="https://api.web3auth.io/session-service",K="https://session.web3auth.io";function v(e={}){let t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),t.server||(t.server={}),t.server.api_url||(t.server.api_url=`${U}/v2`),t.server.socket_url||(t.server.socket_url=`${K}`),t.server.removeTimeout||(t.server.removeTimeout=1e3*60*5),e.methods&&(t.methods=e.methods),t}var De=m,Oe="pubkey.broadcast-channel-0-",p="messages",T={durability:"relaxed"},xe="idb";function V(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){let e=window;if(typeof e.mozIndexedDB<"u")return e.mozIndexedDB;if(typeof e.webkitIndexedDB<"u")return e.webkitIndexedDB;if(typeof e.msIndexedDB<"u")return e.msIndexedDB}return!1}function M(e){e.commit&&e.commit()}function ce(e){let t=V();if(!t)return Promise.reject(new Error("IndexedDB not available"));let s=Oe+e,o=t.open(s);return o.onupgradeneeded=n=>{n.target.result.createObjectStore(p,{keyPath:"id",autoIncrement:!0})},new Promise((n,i)=>{o.onerror=u=>i(u),o.onsuccess=()=>{n(o.result)}})}function ue(e,t,s){let o=Date.now(),r={uuid:t,time:o,data:s},n=e.transaction([p],"readwrite",T);return new Promise((i,u)=>{n.oncomplete=()=>i(),n.onerror=f=>u(f),n.objectStore(p).add(r),M(n)})}function Be(e){let t=e.transaction(p,"readonly",T),s=t.objectStore(p),o=[];return new Promise(r=>{s.openCursor().onsuccess=n=>{let i=n.target.result;i?(o.push(i.value),i.continue()):(M(t),r(o))}})}function de(e,t){let s=e.transaction(p,"readonly",T),o=s.objectStore(p),r=[],n=IDBKeyRange.bound(t+1,1/0);if(o.getAll){let u=o.getAll(n);return new Promise((d,f)=>{u.onerror=g=>f(g),u.onsuccess=function(g){d(g.target.result)}})}function i(){try{return n=IDBKeyRange.bound(t+1,1/0),o.openCursor(n)}catch{return o.openCursor()}}return new Promise((u,d)=>{let f=i();f.onerror=g=>d(g),f.onsuccess=g=>{let E=g.target.result;E?E.value.id<t+1?E.continue(t+1):(r.push(E.value),E.continue()):(M(s),u(r))}})}function le(e,t){let o=e.transaction([p],"readwrite",T).objectStore(p);return Promise.all(t.map(r=>{let n=o.delete(r);return new Promise(i=>{n.onsuccess=()=>i()})}))}function me(e,t){let s=Date.now()-t,o=e.transaction(p,"readonly",T),r=o.objectStore(p),n=[];return new Promise(i=>{r.openCursor().onsuccess=u=>{let d=u.target.result;if(d){let f=d.value;f.time<s?(n.push(f),d.continue()):(M(o),i(n))}else i(n)}})}function fe(e,t){return me(e,t).then(s=>le(e,s.map(o=>o.id)))}function Ue(e,t){return t=v(t),ce(e).then(s=>{let o={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:_(),eMIs:new S(t.idb.ttl*2),writeBlockPromise:h,messagesCallback:null,readQueuePromises:[],db:s,time:m()};return s.onclose=function(){o.closed=!0,t.idb.onclose&&t.idb.onclose()},he(o),o})}function he(e){e.closed||pe(e).then(()=>b(e.options.idb.fallbackInterval)).then(()=>he(e)).catch(t=>{throw t})}function Ke(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function pe(e){return e.closed?h:e.messagesCallback?de(e.db,e.lastCursorId).then(t=>(t.filter(o=>!!o).map(o=>(o.id>e.lastCursorId&&(e.lastCursorId=o.id),o)).filter(o=>Ke(o,e)).sort((o,r)=>o.time-r.time).forEach(o=>{e.messagesCallback&&(e.eMIs.add(o.id),e.messagesCallback(o.data))}),h)):h}function Ve(e){e.closed=!0,e.db.close()}function $e(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(()=>ue(e.db,e.uuid,t)).then(()=>(ie(0,10)===0&&fe(e.db,e.options.idb.ttl),h)),e.writeBlockPromise}function Ye(e,t,s){e.messagesCallbackTime=s,e.messagesCallback=t,pe(e)}function We(){return!!V()}function He(e){return e.idb.fallbackInterval*2}var k={};P(k,{addStorageEventListener:()=>Ee,averageResponseTime:()=>Xe,canBeUsed:()=>_e,close:()=>Qe,create:()=>ze,getLocalStorage:()=>Y,microSeconds:()=>Fe,onMessage:()=>qe,postMessage:()=>Ge,removeStorageEventListener:()=>ge,storageKey:()=>W,type:()=>$});var Fe=m,Je="pubkey.broadcastChannel-",$="localstorage";function Y(){let e=null;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function W(e){return Je+e}function Ge(e,t){return new Promise((s,o)=>{b().then(()=>{var r;let n=W(e.channelName),i={token:_(),time:Date.now(),data:t,uuid:e.uuid},u=JSON.stringify(i);(r=Y())===null||r===void 0||r.setItem(n,u);let d=document.createEvent("StorageEvent");d.initStorageEvent("storage",!0,!0,n,null,u,"",null),window.dispatchEvent(d),s()}).catch(o)})}function Ee(e,t){let s=W(e),o=r=>{r.key===s&&r.newValue&&t(JSON.parse(r.newValue))};return window.addEventListener("storage",o),o}function ge(e){window.removeEventListener("storage",e)}function _e(){let e=Y();if(!e)return!1;try{let t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function ze(e,t){let s=v(t);if(!_e())throw new Error("BroadcastChannel: localstorage cannot be used");let o=_(),r=new S(s.localstorage.removeTimeout),n={channelName:e,uuid:o,time:m(),eMIs:r};return n.listener=Ee(e,i=>{n.messagesCallback&&i.uuid!==o&&(!i.token||r.has(i.token)||i.data.time&&i.data.time<(n.messagesCallbackTime||0)||(r.add(i.token),n.messagesCallback(i.data)))}),n}function Qe(e){e.listener&&ge(e.listener)}function qe(e,t,s){e.messagesCallbackTime=s,e.messagesCallback=t}function Xe(){let t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?240:120}var R={};P(R,{averageResponseTime:()=>rt,canBeUsed:()=>st,close:()=>et,create:()=>Ze,microSeconds:()=>je,onMessage:()=>ot,postMessage:()=>tt,type:()=>H});var je=m,H="native";function Ze(e){let t={time:m(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=s=>{t.messagesCallback&&t.messagesCallback(s.data)},t}function et(e){e.bc.close(),e.subFns=[]}function tt(e,t){try{return e.bc.postMessage(t),h}catch(s){return Promise.reject(s)}}function ot(e,t){e.messagesCallback=t}function st(){if(typeof window>"u")return!1;if(typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1}function rt(){return 150}var L={};P(L,{averageResponseTime:()=>ft,canBeUsed:()=>ut,close:()=>lt,create:()=>dt,getSocketInstance:()=>Se,microSeconds:()=>nt,onMessage:()=>mt,postMessage:()=>at,removeStorageEventListener:()=>ct,setupSocketConnection:()=>we,storageKey:()=>J,type:()=>F});var nt=m,it="pubkey.broadcastChannel-",F="server",I=null,N=new Set;function J(e){return it+e}function at(e,t){return new Promise((s,o)=>{b().then(async()=>{let r=J(e.channelName),n=C(Buffer.from(r,"utf8")),i=await te(n.toString("hex"),{token:_(),time:Date.now(),data:t,uuid:e.uuid}),u={allowedOrigin:e.server.allowed_origin,sameIpCheck:!0,key:x(n).toString("hex"),data:i,signature:(await ee(n,C(Buffer.from(i,"utf8")))).toString("hex")};return e.timeout&&(u.timeout=e.timeout),fetch(`${e.server.api_url}/channel/set`,{method:"POST",body:JSON.stringify(u),headers:{"Content-Type":"application/json; charset=utf-8"}}).then(s).catch(o)}).catch(o)})}function Se(e){if(I)return I;let t=se(e,{transports:["websocket","polling"],withCredentials:!0,reconnectionDelayMax:1e4,reconnectionAttempts:10});return t.on("connect_error",s=>{t.io.opts.transports=["polling","websocket"],l.error("connect error",s)}),t.on("connect",async()=>{let{engine:s}=t.io;l.debug("initially connected to",s.transport.name),s.once("upgrade",()=>{l.debug("upgraded",s.transport.name)}),s.once("close",o=>{l.debug("connection closed",o)})}),t.on("error",s=>{l.error("socket errored",s),t.disconnect()}),I=t,t}function we(e,t,s){let o=Se(e),r=J(t.channelName),n=C(Buffer.from(r,"utf8")),i=x(n).toString("hex");o.connected?o.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin}):o.once("connect",()=>{l.debug("connected with socket"),o.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})});let u=()=>{o.once("connect",async()=>{N.has(t.channelName)&&o.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})})},d=()=>{if(!o||!N.has(t.channelName)){document.removeEventListener("visibilitychange",d);return}!o.connected&&document.visibilityState==="visible"&&u()},f=async g=>{try{let E=await oe(n.toString("hex"),g);l.info(E),s(E)}catch(E){l.error(E)}};return o.on("disconnect",()=>{l.debug("socket disconnected"),N.has(t.channelName)&&(l.error("socket disconnected unexpectedly, reconnecting socket"),u())}),o.on(`${i}_success`,f),typeof document<"u"&&document.addEventListener("visibilitychange",d),o}function ct(){I&&I.disconnect()}function ut(){return!0}function dt(e,t){t=v(t);let s=_(),o=new S(t.server.removeTimeout),r={channelName:e,uuid:s,eMIs:o,server:{api_url:t.server.api_url,socket_url:t.server.socket_url,allowed_origin:t.server.allowed_origin},time:m()};return t.server.timeout&&(r.timeout=t.server.timeout),we(t.server.socket_url,r,n=>{r.messagesCallback&&n.uuid!==r.uuid&&(!n.token||r.eMIs.has(n.token)||(r.eMIs.add(n.token),r.messagesCallback(n.data)))}),N.add(e),r}function lt(e){N.delete(e.channelName)}function mt(e,t,s){e.messagesCallbackTime=s,e.messagesCallback=t}function ft(){return 500}var Q={};P(Q,{SIMULATE_DELAY_TIME:()=>z,averageResponseTime:()=>wt,canBeUsed:()=>St,close:()=>Et,create:()=>pt,microSeconds:()=>ht,onMessage:()=>_t,postMessage:()=>gt,type:()=>D});var ht=m,D="simulate",G=new Set,z=5;function pt(e){let t={time:m(),name:e,messagesCallback:null};return G.add(t),t}function Et(e){G.delete(e)}function gt(e,t){return new Promise(s=>{setTimeout(()=>{Array.from(G).forEach(r=>{r.name===e.name&&r!==e&&r.messagesCallback&&r.time<t.time&&r.messagesCallback(t)}),s()},z)})}function _t(e,t){e.messagesCallback=t}function St(){return!0}function wt(){return z}var ve=[R,A,k,L];function q(e){let t=[].concat(e.methods||[],ve).filter(Boolean);if(e.type){if(e.type==="simulate")return Q;let o=t.find(r=>r.type===e.type);if(o)return o;throw new Error(`method-type ${e.type} not found`)}e.webWorkerSupport||(t=t.filter(o=>o.type!=="idb"));let s=t.find(o=>o.canBeUsed(e));if(s)return s;throw new Error(`No useable method found in ${JSON.stringify(ve.map(o=>o.type))}`)}var X;function vt(e){X=e}var j=new Set,bt=0,y=class{constructor(t,s){c(this,"id",void 0),c(this,"name",void 0),c(this,"options",void 0),c(this,"method",void 0),c(this,"closed",void 0),c(this,"_addEL",void 0),c(this,"_prepP",void 0),c(this,"_state",void 0),c(this,"_uMP",void 0),c(this,"_iL",void 0),c(this,"_onML",void 0),c(this,"_befC",void 0),this.id=bt++,j.add(this),this.name=t,X&&(s=X),this.options=v(s||{}),this.method=q(this.options),this.closed=!1,this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,Tt(this)}get type(){return this.method.type}get isClosed(){return this.closed}set onmessage(t){let o={time:this.method.microSeconds(),fn:t};ye(this,"message",this._onML),t&&typeof t=="function"?(this._onML=o,Te(this,"message",o)):this._onML=null}postMessage(t){if(this.closed)throw new Error(`BroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);return be(this,"message",t)}postInternal(t){return be(this,"internal",t)}addEventListener(t,s){let r={time:this.method.microSeconds(),fn:s};Te(this,t,r)}removeEventListener(t,s){let o=this._addEL[t].find(r=>r.fn===s);ye(this,t,o)}close(){if(this.closed)return Promise.resolve();j.delete(this),this.closed=!0;let t=this._prepP?this._prepP:h;return this._onML=null,this._addEL.message=[],t.then(()=>Promise.all(Array.from(this._uMP))).then(()=>Promise.all(this._befC.map(s=>s()))).then(()=>this.method.close?this.method.close(this._state):h)}};c(y,"_pubkey",!0);function be(e,t,s){let r={time:e.method.microSeconds(),type:t,data:s};return(e._prepP?e._prepP:h).then(()=>{let i=e.method.postMessage(e._state,r);return e._uMP.add(i),i.catch(()=>{}).then(()=>e._uMP.delete(i)),i})}function Tt(e){let t=e.method.create(e.name,e.options);if(ne(t)){let s=t;e._prepP=s,s.then(o=>(e._state=o,o)).catch(o=>{throw o})}else e._state=t}function Pe(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function yt(e){if(!e._iL&&Pe(e)){let t=o=>{e._addEL[o.type].forEach(r=>{(o.time>=r.time||e.method.type==="server")&&r.fn(o.data)})},s=e.method.microSeconds();e._prepP?e._prepP.then(()=>(e._iL=!0,e.method.onMessage(e._state,t,s),!0)).catch(o=>{throw o}):(e._iL=!0,e.method.onMessage(e._state,t,s))}}function Pt(e){if(e._iL&&!Pe(e)){e._iL=!1;let t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function Te(e,t,s){e._addEL[t].push(s),yt(e)}function ye(e,t,s){s&&(e._addEL[t]=e._addEL[t].filter(o=>o!==s),Pt(e))}var Z=class{constructor(t,s={}){c(this,"name",void 0),c(this,"options",void 0),c(this,"closed",void 0),c(this,"onML",void 0),c(this,"methodPriority",void 0),c(this,"channels",void 0),c(this,"listeners",void 0),c(this,"processedNonces",void 0),c(this,"nonce",void 0),this.name=t,this.options=s,this.closed=!1,this.onML=null,this.methodPriority=[H,$,F],this.channels=new Map,this.listeners=new Set,this.processedNonces=new Set,this.nonce=0,this.initChannels()}set onmessage(t){this.removeEventListener("message",this.onML),t&&typeof t=="function"?(this.onML=t,this.addEventListener("message",t)):this.onML=null}initChannels(){if(this.options.type===D&&(this.methodPriority=[D]),this.methodPriority.forEach(t=>{try{let s=new y(this.name,O(O({},this.options),{},{type:t}));this.channels.set(t,s),l.debug(`Succeeded to initialize ${t} method in channel ${this.name}`),s.onmessage=o=>this.handleMessage(o)}catch(s){l.warn(`Failed to initialize ${t} method in channel ${this.name}: ${s instanceof Error?s.message:String(s)}`)}}),this.channels.size===0)throw new Error("Failed to initialize any communication method")}allChannels(){return Array.from(this.channels.keys())}hasChannel(t){return this.channels.has(t)}handleMessage(t){if(t&&t.nonce){if(this.processedNonces.has(t.nonce))return;if(this.processedNonces.add(t.nonce),this.processedNonces.size>1e3){let o=Array.from(this.processedNonces).sort()[0];this.processedNonces.delete(o)}this.listeners.forEach(s=>{s(t.message)})}}async postMessage(t){if(this.closed)throw new Error(`AdaptiveBroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);let o={nonce:this.generateNonce(),message:t},r=Array.from(this.channels.entries()).map(([u,d])=>d.postMessage(o).catch(f=>{throw l.warn(`Failed to send via ${u}: ${f.message}`),f}));if(!(await Promise.allSettled(r)).some(u=>u.status==="fulfilled"))throw new Error("Failed to send message through any method");return t}generateNonce(){return`${Date.now()}-${this.nonce++}`}addEventListener(t,s){this.listeners.add(s)}removeEventListener(t,s){this.listeners.delete(s)}async close(){if(this.closed)return;this.onML=null;let t=[];for(let s of this.channels.values())t.push(s.close());await Promise.all(t),this.channels.clear(),this.listeners.clear(),this.closed=!0}};export{y as BroadcastChannel,A as IndexedDbMethod,k as LocalstorageMethod,R as NativeMethod,j as OPEN_BROADCAST_CHANNELS,Z as RedundantAdaptiveBroadcastChannel,L as ServerMethod,q as chooseMethod,vt as enforceOptions};
