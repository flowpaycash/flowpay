import{a as Q}from"./chunk-K2FCTDOA.js";import{a as k,d as A,e as E,g as F,h as I,i as L,j as R,k as C,l as w}from"./chunk-IUNNABVL.js";import{b as O,h as N,i as S,j as B}from"./chunk-GEDAPGUD.js";import{c as z,k as M,l as q,n as j}from"./chunk-PVBWCU6O.js";import{b as m,d,e as c,f as b}from"./chunk-U5CWZESK.js";import"./chunk-5XACWPQJ.js";import{e as P}from"./chunk-GMMKJC3W.js";import{g as x}from"./chunk-BG6P72OF.js";var p=x(q());function W(i){return i.toLowerCase().replace(".","").replace(/\s+/g,"-")}function V(i,t){return t===void 0&&(t=!1),t?btoa(i).replace(/=/g,""):void 0}function G(i){return("Integration"in i?i.Integration:i).prototype.name}function tt(i,t,n){var e,o;try{var r=((o=(e=window?.performance)===null||e===void 0?void 0:e.getEntriesByName(i,"resource"))!==null&&o!==void 0?o:[])[0];r&&t.stats.gauge("legacy_destination_time",Math.round(r.duration),b([n],r.duration<100?["cached"]:[],!0))}catch{}}function T(i,t,n){var e;if("Integration"in i){var o={user:function(){return n.user()},addIntegration:function(){}};i(o),e=i.Integration}else e=i;var r=new e(t);return r.analytics=n,r}function U(i,t,n,e){return d(this,void 0,void 0,function(){var o,r,a,u,s,f;return c(this,function(h){switch(h.label){case 0:o=W(t),r=V(o,e),a=N(),u="".concat(a,"/integrations/").concat(r??o,"/").concat(n,"/").concat(r??o,".dynamic.js.gz"),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,S(u)];case 2:return h.sent(),tt(u,i,t),[3,4];case 3:throw s=h.sent(),i.stats.gauge("legacy_destination_time",-1,["plugin:".concat(t),"failed"]),s;case 4:return f=window["".concat(o,"Deps")],[4,Promise.all(f.map(function(g){return S(a+g+".gz")}))];case 5:return h.sent(),window["".concat(o,"Loader")](),[2,window["".concat(o,"Integration")]]}})})}function H(i,t,n){return d(this,void 0,void 0,function(){var e,o,r,a;return c(this,function(u){return e=N(),o=W(i),r=V(i,n),a="".concat(e,"/integrations/").concat(r??o,"/").concat(t,"/").concat(r??o,".dynamic.js.gz"),[2,B(a)]})})}function J(i){var t,n,e,o;return(o=(n=(t=i?.versionSettings)===null||t===void 0?void 0:t.override)!==null&&n!==void 0?n:(e=i?.versionSettings)===null||e===void 0?void 0:e.version)!==null&&o!==void 0?o:"latest"}var K=function(i,t){var n,e=t.type,o=t.bundlingStatus,r=t.versionSettings,a=o!=="unbundled"&&(e==="browser"||((n=r?.componentTypes)===null||n===void 0?void 0:n.includes("browser")));return!i.startsWith("Segment")&&i!=="Iterable"&&a},X=function(i,t){var n=t.All===!1&&t[i]===void 0;return t[i]===!1||n};function et(i,t){return d(this,void 0,void 0,function(){var n,e=this;return c(this,function(o){switch(o.label){case 0:return n=[],I()?[2,t]:[4,R(function(){return t.length>0&&F()},function(){return d(e,void 0,void 0,function(){var r,a,u;return c(this,function(s){switch(s.label){case 0:return r=t.pop(),r?[4,E(r,i)]:[2];case 1:return a=s.sent(),u=a instanceof M,u||n.push(r),[2]}})})})];case 1:return o.sent(),n.map(function(r){return t.pushWithBackoff(r)}),[2,t]}})})}var it=(function(){function i(t,n,e,o,r,a){o===void 0&&(o={});var u=this;this.options={},this.type="destination",this.middleware=[],this.initializePromise=k(),this.flushing=!1,this.name=t,this.version=n,this.settings=m({},o),this.disableAutoISOConversion=r.disableAutoISOConversion||!1,this.integrationSource=a,this.settings.type&&this.settings.type==="browser"&&delete this.settings.type,this.initializePromise.promise.then(function(s){return u._initialized=s},function(){}),this.options=r,this.buffer=r.disableClientPersistence?new A(4,[]):new L(4,"".concat(e,":dest-").concat(t)),this.scheduleFlush()}return i.prototype.isLoaded=function(){return!!this._ready},i.prototype.ready=function(){var t=this;return this.initializePromise.promise.then(function(){var n;return(n=t.onReady)!==null&&n!==void 0?n:Promise.resolve()})},i.prototype.load=function(t,n){var e;return d(this,void 0,void 0,function(){var o,r,a=this;return c(this,function(u){switch(u.label){case 0:return this._ready||this.onReady!==void 0?[2]:(e=this.integrationSource)!==null&&e!==void 0?(r=e,[3,3]):[3,1];case 1:return[4,U(t,this.name,this.version,this.options.obfuscate)];case 2:r=u.sent(),u.label=3;case 3:o=r,this.integration=T(o,this.settings,n),this.onReady=new Promise(function(s){var f=function(){a._ready=!0,s(!0)};a.integration.once("ready",f)}),this.integration.on("initialize",function(){a.initializePromise.resolve(!0)});try{w(t,{integrationName:this.name,methodName:"initialize",type:"classic"}),this.integration.initialize()}catch(s){throw w(t,{integrationName:this.name,methodName:"initialize",type:"classic",didError:!0}),this.initializePromise.resolve(!1),s}return[2]}})})},i.prototype.unload=function(t,n){return H(this.name,this.version,this.options.obfuscate)},i.prototype.addMiddleware=function(){for(var t,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];this.middleware=(t=this.middleware).concat.apply(t,n)},i.prototype.shouldBuffer=function(t){return t.event.type!=="page"&&(I()||this._ready!==!0||this._initialized!==!0)},i.prototype.send=function(t,n,e){var o,r;return d(this,void 0,void 0,function(){var a,u,s,f,h,g;return c(this,function(v){switch(v.label){case 0:return this.shouldBuffer(t)?(this.buffer.push(t),this.scheduleFlush(),[2,t]):(a=(r=(o=this.options)===null||o===void 0?void 0:o.plan)===null||r===void 0?void 0:r.track,u=t.event.event,a&&u&&this.name!=="Segment.io"&&(s=a[u],Q(a,s)?t.updateEvent("integrations",m(m({},t.event.integrations),s?.integrations)):(t.updateEvent("integrations",m(m({},t.event.integrations),{All:!1,"Segment.io":!0})),t.cancel(new z({retry:!1,reason:"Event ".concat(u," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),s?.enabled&&s?.integrations[this.name]===!1&&t.cancel(new z({retry:!1,reason:"Event ".concat(u," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),[4,j(this.name,t.event,this.middleware)]);case 1:if(f=v.sent(),f===null)return[2,t];h=new n(f,{traverse:!this.disableAutoISOConversion}),w(t,{integrationName:this.name,methodName:e,type:"classic"}),v.label=2;case 2:return v.trys.push([2,5,,6]),this.integration?[4,this.integration.invoke.call(this.integration,e,h)]:[3,4];case 3:v.sent(),v.label=4;case 4:return[3,6];case 5:throw g=v.sent(),w(t,{integrationName:this.name,methodName:e,type:"classic",didError:!0}),g;case 6:return[2,t]}})})},i.prototype.track=function(t){return d(this,void 0,void 0,function(){return c(this,function(n){return[2,this.send(t,p.Track,"track")]})})},i.prototype.page=function(t){var n;return d(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return!((n=this.integration)===null||n===void 0)&&n._assumesPageview&&!this._initialized&&this.integration.initialize(),[4,this.initializePromise.promise];case 1:return e.sent(),[2,this.send(t,p.Page,"page")]}})})},i.prototype.identify=function(t){return d(this,void 0,void 0,function(){return c(this,function(n){return[2,this.send(t,p.Identify,"identify")]})})},i.prototype.alias=function(t){return d(this,void 0,void 0,function(){return c(this,function(n){return[2,this.send(t,p.Alias,"alias")]})})},i.prototype.group=function(t){return d(this,void 0,void 0,function(){return c(this,function(n){return[2,this.send(t,p.Group,"group")]})})},i.prototype.scheduleFlush=function(){var t=this;this.flushing||setTimeout(function(){return d(t,void 0,void 0,function(){var n;return c(this,function(e){switch(e.label){case 0:return I()||this._ready!==!0||this._initialized!==!0?(this.scheduleFlush(),[2]):(this.flushing=!0,n=this,[4,et(this,this.buffer)]);case 1:return n.buffer=e.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},Math.random()*5e3)},i})();function zt(i,t,n,e,o,r){var a,u;if(n===void 0&&(n={}),e===void 0&&(e={}),O())return[];t.plan&&(e=e??{},e.plan=t.plan);var s=(u=(a=t.middlewareSettings)===null||a===void 0?void 0:a.routingRules)!==null&&u!==void 0?u:[],f=t.integrations,h=e.integrations,g=C(t,e??{}),v=r?.reduce(function(l,_){var y;return m(m({},l),(y={},y[G(_)]=_,y))},{}),Y=new Set(b(b([],Object.keys(f).filter(function(l){return K(l,f[l])}),!0),Object.keys(v||{}).filter(function(l){return P(f[l])||P(h?.[l])}),!0));return Array.from(Y).filter(function(l){return!X(l,n)}).map(function(l){var _=f[l],y=J(_),D=new it(l,y,i,g[l],e,v?.[l]),Z=s.filter(function($){return $.destinationName===l});return Z.length>0&&o&&D.addMiddleware(o),D})}export{it as LegacyDestination,zt as ajsDestinations};
