---
---

<section id="pix-mode" class="mode-section">
  <form id="pix-form" class="card">
    <label for="product-selector">Produto / Plano</label>
    <select name="product_id" id="product-selector" class="nf-input">
      <option value="" disabled selected>Selecione um produto...</option>
    </select>

    <label for="wallet">Sua Carteira</label>
    <input name="wallet" id="wallet" placeholder="0x..." autocomplete="off" class="nf-input" />

    <label for="valor">Valor (BRL)</label>
    <input name="valor" id="valor" type="number" step="0.01" min="0.01" placeholder="0.00" readonly class="nf-input" />

    <input type="hidden" name="moeda" value="BRL" />
    <input type="hidden" name="id_transacao" id="id_transacao" />

    <button class="primary" type="submit">Confirmar Pagamento</button>
    <button class="text" type="button" data-action="reset">Cancelar</button>
  </form>
</section>

<script is:inline>
  document.addEventListener('DOMContentLoaded', async () => {
    const selector = document.getElementById('product-selector');
    const valorField = document.getElementById('valor');
    const walletField = document.getElementById('wallet');
    
    // Draft functionality
    const saveDraft = () => {
      const draft = {
        productRef: selector.value,
        wallet: walletField.value
      };
      localStorage.setItem('flowpay_checkout_draft', JSON.stringify(draft));
    };

    try {
      const resp = await fetch('/api/products');
      const products = await resp.json();

      // Restore Draft - Step 1: Load data
      let draft = {};
      try {
        const saved = localStorage.getItem('flowpay_checkout_draft');
        if (saved) draft = JSON.parse(saved);
      } catch (e) { console.warn('Failed to parse draft', e); }

      products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.ref;
        opt.dataset.price = p.price_brl;
        opt.textContent = `${p.name} - R$ ${p.price_brl.toFixed(2)}`;
        
        // Restore product selection
        if (draft.productRef === p.ref) opt.selected = true;
        
        selector.appendChild(opt);
      });

      // Trigger change to update price if restored
      if (draft.productRef) {
          const selected = selector.options[selector.selectedIndex];
          if (selected && selected.dataset.price) {
              valorField.value = selected.dataset.price;
          }
      }

      // Restore wallet
      if (draft.wallet) walletField.value = draft.wallet;

      selector.addEventListener('change', (e) => {
        const selected = e.target.options[e.target.selectedIndex];
        if (selected.dataset.price) {
          valorField.value = selected.dataset.price;
          valorField.dispatchEvent(new Event('input'));
        }
        saveDraft();
      });

      walletField.addEventListener('input', saveDraft);

    } catch (err) {
      console.error('‚ùå Erro ao carregar produtos:', err);
    }
  });
</script>
