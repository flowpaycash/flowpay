---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
---

<Layout title="FLOWPay - Transparencia Radical">
  <Navbar />

  <main class="transparency-page">
    <header class="page-header">
      <div class="glow-sphere"></div>
      <h1 class="page-title">
        Provas, não <span class="gradient-text">Promessas</span>.
      </h1>
      <p class="page-subtitle">
        Operação auditável em tempo real. Privacidade por padrão, transparência
        por design.
      </p>
    </header>

    <div class="container">
      <!-- Status do Sistema -->
      <section class="status-bar" id="system-status">
        <div class="status-indicator">
          <span class="pulse-dot" id="status-dot"></span>
          <span class="status-label" id="status-label">Verificando...</span>
        </div>
        <div class="status-meta" id="status-meta"></div>
      </section>

      <!-- Stats em tempo real -->
      <section class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Volume Total (BRL)</span>
          <span class="stat-value" id="total-volume">--</span>
          <span class="stat-sub" id="volume-24h">Ultimas 24h: --</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Transacoes Liquidadas</span>
          <span class="stat-value" id="settled-count">--</span>
          <span class="stat-sub" id="total-orders">Total processado: --</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Provas On-Chain (PoE)</span>
          <span class="stat-value" id="poe-count">--</span>
          <span class="stat-sub">Merkle root anchorada na Base</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Volume 30 dias</span>
          <span class="stat-value" id="volume-30d">--</span>
          <span class="stat-sub" id="orders-30d">-- transacoes</span>
        </div>
      </section>

      <!-- Cards de principios -->
      <section class="principles-grid">
        <div class="principle-card">
          <div class="principle-icon">&#128065;</div>
          <h3>O que é Público</h3>
          <p>
            Status da rede, volumes transacionados e hashes de liquidação
            blockchain.
          </p>
          <ul class="principle-list">
            <li>Timestamps reais de cada transação</li>
            <li>ID de correlação único por charge</li>
            <li>Status de liquidação on-chain</li>
            <li>Merkle root de cada batch de PoE</li>
          </ul>
        </div>

        <div class="principle-card">
          <div class="principle-icon">&#128737;</div>
          <h3>O que é Privado</h3>
          <p>
            Seus dados são seus. Não armazenamos PII (Personally Identifiable
            Information).
          </p>
          <ul class="principle-list">
            <li>Sem KYC intrusivo</li>
            <li>Sem registro de IPs</li>
            <li>Payloads redigidos nos logs</li>
            <li>Dados de pagamento nunca expostos</li>
          </ul>
        </div>

        <div class="principle-card highlight">
          <div class="principle-icon">&#9881;</div>
          <h3>Auditável por Design</h3>
          <p>
            Cada transação gera uma prova criptográfica ancorada on-chain pela <strong
              >NEO Smart Factory™</strong
            >, verificável por qualquer pessoa a qualquer momento.
          </p>
          <a
            href="https://nsfactory.xyz"
            target="_blank"
            rel="noopener noreferrer"
            class="btn-repo"
          >
            NEO Smart Factory™
          </a>
        </div>
      </section>

      <!-- Liquidacoes Recentes -->
      <section class="table-section">
        <div class="section-header">
          <h2>Liquidacoes Recentes</h2>
          <span class="section-badge">Prova on-chain</span>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="settlements-table">
            <thead>
              <tr>
                <th>Charge ID</th>
                <th>Valor (BRL)</th>
                <th>Status</th>
                <th>Rede</th>
                <th>TX Hash</th>
                <th>Data</th>
              </tr>
            </thead>
            <tbody id="settlements-body">
              <tr><td colspan="6" class="loading-row">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Batches de PoE -->
      <section class="table-section">
        <div class="section-header">
          <h2>Proof of Existence — Batches</h2>
          <span class="section-badge">Merkle Tree</span>
        </div>
        <p class="section-desc">
          Cada batch agrupa múltiplas transações em uma Merkle Tree e ancora o
          root hash on-chain, provando a existência e integridade de todos os
          pagamentos sem expor dados individuais.
        </p>
        <div class="table-wrapper">
          <table class="data-table" id="poe-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Merkle Root</th>
                <th>Transacoes</th>
                <th>Anchor TX</th>
                <th>Rede</th>
                <th>Anchorado em</th>
              </tr>
            </thead>
            <tbody id="poe-body">
              <tr><td colspan="6" class="loading-row">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Rodape de auditoria -->
      <section class="audit-footer">
        <div class="audit-item">
          <span class="audit-label">API de Transparencia</span>
          <a href="/api/transparency" target="_blank" class="audit-link"
            >/api/transparency</a
          >
        </div>
        <div class="audit-item">
          <span class="audit-label">Infraestrutura</span>
          <a
            href="https://nsfactory.xyz"
            target="_blank"
            rel="noopener noreferrer"
            class="audit-link">NEO Smart Factory™</a
          >
        </div>
        <div class="audit-item">
          <span class="audit-label">Rede Blockchain</span>
          <a
            href="https://basescan.org"
            target="_blank"
            rel="noopener noreferrer"
            class="audit-link">Base (basescan.org)</a
          >
        </div>
        <div class="audit-item">
          <span class="audit-label">Atualizado em</span>
          <span class="audit-value" id="generated-at">--</span>
        </div>
      </section>
    </div>
  </main>

  <style>
    .transparency-page {
      padding-top: 120px;
      padding-bottom: 100px;
      background: #050505;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Header */
    .page-header {
      text-align: center;
      margin-bottom: 64px;
      position: relative;
      padding: 0 24px;
    }

    .glow-sphere {
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: radial-gradient(
        circle,
        rgba(255, 0, 122, 0.08) 0%,
        transparent 70%
      );
      pointer-events: none;
    }

    .page-title {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 800;
      color: #fff;
      margin-bottom: 16px;
      letter-spacing: -0.03em;
    }

    .gradient-text {
      background: linear-gradient(135deg, #ff007a, #ff4da6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.45);
      max-width: 560px;
      margin: 0 auto;
      line-height: 1.7;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: white;
      padding: 16px 28px;
      border-radius: 16px;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 12px;
      backdrop-filter: blur(12px);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pulse-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #444;
      flex-shrink: 0;
    }

    .pulse-dot.online {
      background: #00ff88;
      box-shadow: 0 0 8px #00ff88;
      animation: pulse 2s infinite;
    }

    .pulse-dot.offline {
      background: #ff4444;
      box-shadow: 0 0 8px #ff4444;
    }

    .status-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #fff;
    }

    .status-meta {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.35);
      font-family: monospace;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.6);
        opacity: 0.4;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 48px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition:
        border-color 0.2s,
        transform 0.2s;
    }

    .stat-card:hover {
      border-color: rgba(255, 0, 122, 0.2);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.35);
      font-weight: 600;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: #fff;
      letter-spacing: -0.02em;
      line-height: 1;
    }

    .stat-sub {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.3);
    }

    /* Principles */
    .principles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 64px;
    }

    .principle-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 24px;
      padding: 36px;
      transition:
        transform 0.2s,
        border-color 0.2s;
    }

    .principle-card:hover {
      transform: translateY(-4px);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .principle-card.highlight {
      border-color: rgba(255, 0, 122, 0.2);
      background: linear-gradient(
        160deg,
        rgba(255, 0, 122, 0.05) 0%,
        rgba(255, 122, 0, 0.03) 100%
      );
    }

    .principle-icon {
      font-size: 34px;
      margin-bottom: 20px;
      display: block;
    }

    .principle-card h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 10px;
    }

    .principle-card p {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.88rem;
      line-height: 1.7;
      margin-bottom: 20px;
    }

    .principle-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .principle-list li {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.55);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .principle-list li::before {
      content: "";
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #ff007a;
      flex-shrink: 0;
    }

    .btn-repo {
      display: inline-block;
      background: linear-gradient(135deg, #ff007a, #ff4da6);
      color: white;
      text-decoration: none;
      padding: 11px 22px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.85rem;
      transition:
        opacity 0.2s,
        transform 0.2s;
    }

    .btn-repo:hover {
      opacity: 0.88;
      transform: translateY(-1px);
    }

    /* Tables */
    .table-section {
      margin-bottom: 56px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 12px;
    }

    .section-header h2 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
    }

    .section-badge {
      background: rgba(255, 0, 122, 0.1);
      color: #ff007a;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 100px;
      border: 1px solid rgba(255, 0, 122, 0.2);
    }

    .section-desc {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.35);
      line-height: 1.7;
      margin-bottom: 20px;
      max-width: 720px;
    }

    .table-wrapper {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      overflow: hidden;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.84rem;
    }

    .data-table thead {
      background: rgba(255, 255, 255, 0.03);
    }

    .data-table th {
      padding: 13px 20px;
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: rgba(255, 255, 255, 0.3);
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .data-table td {
      padding: 13px 20px;
      color: rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      vertical-align: middle;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    .loading-row {
      text-align: center;
      color: rgba(255, 255, 255, 0.2);
      padding: 40px !important;
    }

    .empty-row {
      text-align: center;
      color: rgba(255, 255, 255, 0.2);
      padding: 40px !important;
      font-size: 0.85rem;
    }

    .tx-hash {
      font-family: monospace;
      font-size: 0.78rem;
      color: #ff007a;
      text-decoration: none;
      white-space: nowrap;
    }

    .tx-hash:hover {
      text-decoration: underline;
    }

    .hash-short {
      font-family: monospace;
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.35);
    }

    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 100px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-badge.settled,
    .status-badge.completed {
      background: rgba(0, 200, 100, 0.12);
      color: #00cc66;
      border: 1px solid rgba(0, 200, 100, 0.2);
    }

    .status-badge.pending {
      background: rgba(255, 165, 0, 0.12);
      color: #ffaa00;
      border: 1px solid rgba(255, 165, 0, 0.2);
    }

    .status-badge.paid {
      background: rgba(0, 150, 255, 0.12);
      color: #4db6ff;
      border: 1px solid rgba(0, 150, 255, 0.2);
    }

    .network-badge {
      font-size: 0.7rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.06);
      padding: 3px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Audit Footer */
    .audit-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      padding: 28px 32px;
      align-items: center;
    }

    .audit-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .audit-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.25);
      font-weight: 600;
    }

    .audit-link {
      font-size: 0.84rem;
      color: #ff007a;
      text-decoration: none;
      font-family: monospace;
    }

    .audit-link:hover {
      text-decoration: underline;
    }

    .audit-value {
      font-size: 0.84rem;
      color: rgba(255, 255, 255, 0.35);
      font-family: monospace;
    }

    @media (max-width: 640px) {
      .transparency-page {
        padding-top: 90px;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .audit-footer {
        gap: 20px;
        padding: 20px 24px;
      }
      .data-table th,
      .data-table td {
        padding: 10px 12px;
      }
    }
  </style>

  <script is:inline src="/csp-config.js"></script>

  <script>
    function formatBRL(value) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
      }).format(parseFloat(value) || 0);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "--";
      return new Date(dateStr).toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function shortHash(hash) {
      if (!hash) return "--";
      return hash.substring(0, 8) + "..." + hash.substring(hash.length - 6);
    }

    function statusBadge(status) {
      const map = {
        SETTLED: "settled",
        COMPLETED: "completed",
        PIX_PAID: "paid",
        PENDING_REVIEW: "pending",
        APPROVED: "pending",
      };
      const cls = map[status] || "pending";
      return `<span class="status-badge ${cls}">${status}</span>`;
    }

    function getExplorerUrl(txHash, network) {
      if (!txHash) return null;
      const explorers = {
        base: "https://basescan.org/tx/",
        ethereum: "https://etherscan.io/tx/",
        polygon: "https://polygonscan.com/tx/",
      };
      const base = explorers[network] || explorers["base"];
      return base + txHash;
    }

    async function loadTransparency() {
      try {
        const res = await fetch("/api/transparency");
        const data = await res.json();

        if (!data.ok) throw new Error("API unavailable");

        // Helper to update elements safely
        const updateText = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };

        // Status
        const dot = document.getElementById("status-dot");
        const label = document.getElementById("status-label");
        const meta = document.getElementById("status-meta");

        if (data.system.status === "operational") {
          if (dot) dot.classList.add("online");
          if (label) label.textContent = "Sistema Operacional";
        } else {
          if (dot) dot.classList.add("offline");
          if (label) label.textContent = "Sistema Degradado";
        }
        if (meta)
          meta.textContent = `v${data.system.version} · Rede ${data.system.network} · Atualizado ${formatDate(data.generated_at)}`;

        // Stats
        updateText("total-volume", formatBRL(data.stats.total_volume_brl));
        updateText(
          "volume-24h",
          `Ultimas 24h: ${formatBRL(data.stats.last_24h.volume_brl)}`
        );
        updateText(
          "settled-count",
          data.stats.settled_count.toLocaleString("pt-BR")
        );
        updateText(
          "total-orders",
          `Total processado: ${data.stats.total_orders.toLocaleString("pt-BR")}`
        );
        updateText(
          "poe-count",
          data.poe_batches.length > 0 ? data.poe_batches.length + "+" : "0"
        );
        updateText("volume-30d", formatBRL(data.stats.last_30d.volume_brl));
        updateText(
          "orders-30d",
          `${data.stats.last_30d.orders.toLocaleString("pt-BR")} transacoes`
        );
        updateText("generated-at", formatDate(data.generated_at));

        // Settlements table
        const tbody = document.getElementById("settlements-body");
        if (tbody) {
          if (data.recent_settlements.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-row">Nenhuma liquidacao on-chain registrada ainda.</td></tr>';
          } else {
            tbody.innerHTML = data.recent_settlements
              .map((s) => {
                const explorerUrl = getExplorerUrl(s.tx_hash, s.network);
                const txCell = explorerUrl
                  ? `<a href="${explorerUrl}" target="_blank" rel="noopener noreferrer" class="tx-hash">${shortHash(s.tx_hash)}</a>`
                  : `<span class="hash-short">--</span>`;
                return `
                <tr>
                  <td><span class="hash-short">${shortHash(s.charge_id)}</span></td>
                  <td><strong>${formatBRL(s.amount_brl)}</strong></td>
                  <td>${statusBadge(s.status)}</td>
                  <td><span class="network-badge">${s.network}</span></td>
                  <td>${txCell}</td>
                  <td>${formatDate(s.settled_at || s.created_at)}</td>
                </tr>
              `;
              })
              .join("");
          }
        }

        // PoE table
        const poebody = document.getElementById("poe-body");
        if (poebody) {
          if (data.poe_batches.length === 0) {
            poebody.innerHTML =
              '<tr><td colspan="6" class="empty-row">Nenhum batch de PoE anchorado ainda.</td></tr>';
          } else {
            poebody.innerHTML = data.poe_batches
              .map((b) => {
                const anchorUrl = getExplorerUrl(b.anchor_tx_hash, b.network);
                const anchorCell = anchorUrl
                  ? `<a href="${anchorUrl}" target="_blank" rel="noopener noreferrer" class="tx-hash">${shortHash(b.anchor_tx_hash)}</a>`
                  : `<span class="hash-short">Pendente</span>`;
                return `
                <tr>
                  <td>#${b.id}</td>
                  <td><span class="hash-short">${shortHash(b.merkle_root)}</span></td>
                  <td>${b.batch_size}</td>
                  <td>${anchorCell}</td>
                  <td><span class="network-badge">${b.network}</span></td>
                  <td>${formatDate(b.anchored_at || b.created_at)}</td>
                </tr>
              `;
              })
              .join("");
          }
        }
      } catch (err) {
        const dot = document.getElementById("status-dot");
        if (dot) dot.classList.add("offline");

        const label = document.getElementById("status-label");
        if (label) label.textContent = "Dados temporariamente indisponiveis";

        const settlementsBody = document.getElementById("settlements-body");
        if (settlementsBody) {
          settlementsBody.innerHTML =
            '<tr><td colspan="6" class="empty-row">Nao foi possivel carregar os dados.</td></tr>';
        }

        const poeBody = document.getElementById("poe-body");
        if (poeBody) {
          poeBody.innerHTML =
            '<tr><td colspan="6" class="empty-row">Nao foi possivel carregar os dados.</td></tr>';
        }
      }
    }

    document.addEventListener("DOMContentLoaded", loadTransparency);
  </script>
</Layout>
