---
import CheckoutLayout from '../layouts/CheckoutLayout.astro';
import CheckoutHeader from '../components/checkout/CheckoutHeader.astro';
import ModeChooser from '../components/checkout/ModeChooser.astro';
import PixForm from '../components/checkout/PixForm.astro';
import CryptoForm from '../components/checkout/CryptoForm.astro';
import CheckoutFooter from '../components/checkout/CheckoutFooter.astro';
---

<CheckoutLayout>
  <CheckoutHeader />

  <main class="checkout-main">
    <ModeChooser />

    <section class="flow-step" data-state="details" id="step-details" hidden>
      <PixForm />
      <CryptoForm />
    </section>

    <section class="flow-step" data-state="confirm" id="step-confirm" hidden>
      <div class="card success">
        <h3>Pagamento em processamento</h3>
        <p>Registrando prova e atualizando statusâ€¦</p>
        <ul id="footnote" class="foot"></ul>
        <div class="actions">
          <a class="primary" href="/transparency">Ver transparÃªncia</a>
          <button class="text" data-action="reset">Iniciar novo fluxo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading overlay -->
  <div id="nf-loading" class="nf-loading" style="display:none">
    <div class="nf-card">
      <div class="nf-spinner" aria-hidden="true"></div>
      <p class="nf-title">Carregandoâ€¦</p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="nf-toasts" class="nf-toasts"></div>

  <CheckoutFooter />
</CheckoutLayout>

<!-- Wallet Boot Loader NÎžÃ˜ -->
<script is:inline>
  (async () => {
    try {
      const r = await fetch('/.netlify/functions/neo-config', { cache: 'no-store' });
      if (r.ok) window.NEO_CONFIG = await r.json();
    } catch {}
  })();
</script>

<!-- Scripts principais -->
<script type="module" src="/assets/js/wallet.boot.js"></script>
<script type="module" src="/assets/js/navigation-flow.machine.js"></script>

<!-- Checkout initialization script -->
<script type="module">
  import { startCheckout } from '/assets/js/navigation-flow.machine.js';

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('ðŸš€ Initializing FLOWPay...');

    // Mount progress bar
    const header = document.querySelector('.checkout-header');
    if (header) {
      const el = document.createElement('div');
      el.className = 'nf-progress';
      el.innerHTML = `
        <div class="nf-bar">
          <div class="nf-fill" id="nf-fill"></div>
        </div>
        <div class="nf-dots">
          <button class="nf-dot" data-action="goto" data-step="0" aria-label="Escolha"></button>
          <button class="nf-dot" data-action="goto" data-step="1" aria-label="Detalhes"></button>
          <button class="nf-dot" data-action="goto" data-step="2" aria-label="Confirmar"></button>
        </div>
      `;
      header.appendChild(el);
    }

    // Load copy
    let copy = {};
    try {
      const res = await fetch('/ui.copy.pt.json', { cache: 'no-store' });
      if (res.ok) copy = await res.json();
      console.log('âœ… Copy loaded:', copy);
    } catch (error) {
      console.warn('âš ï¸ Copy loading failed:', error);
    }

    let svc;
    try {
      svc = startCheckout({
        copy,
        services: {
          createPix: async (ctx, p) => {
            console.log('ðŸ”„ Creating PIX charge via Woovi API:', p);

            try {
              const response = await fetch('/.netlify/functions/create-pix-charge', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(p),
              });

              const responseData = await response.json();

              if (!response.ok) {
                let errorMessage = 'Erro ao criar cobranÃ§a PIX';

                if (responseData.error) {
                  errorMessage = responseData.error;
                } else if (responseData.details && responseData.details.apiError) {
                  errorMessage =
                    responseData.details.apiError.message || responseData.details.apiError;
                } else if (responseData.message) {
                  errorMessage = responseData.message;
                }

                console.error('âŒ Error creating PIX charge:', {
                  status: response.status,
                  statusText: response.statusText,
                  error: errorMessage,
                  details: responseData.details,
                  fullResponse: responseData,
                });

                const error = new Error(errorMessage);
                error.status = response.status;
                error.details = responseData.details;
                throw error;
              }

              console.log('âœ… PIX charge created successfully:', responseData);
              return responseData;
            } catch (error) {
              console.error('âŒ Error creating PIX charge:', {
                message: error.message,
                status: error.status,
                details: error.details,
                stack: error.stack,
              });
              throw error;
            }
          },
          submitCrypto: (ctx, p) => {
            console.log('ðŸ”„ Submitting crypto:', p);
            return Promise.resolve({
              success: true,
              hash: `0x${Math.random().toString(16).slice(2)}`,
            });
          },
          connect: () => window.connectWallet?.(),
          disconnect: () => window.disconnectWallet?.(),
        },
        onToast: (msg, type) => {
          let holder = document.getElementById('nf-toasts');
          if (!holder) {
            holder = document.createElement('div');
            holder.id = 'nf-toasts';
            holder.className = 'nf-toasts';
            document.body.appendChild(holder);
          }
          const n = document.createElement('div');
          n.className = `nf-toast is-${type || 'info'}`;
          n.innerHTML = `<span>${msg}</span><button class="nf-x" aria-label="Fechar">Ã—</button>`;
          holder.appendChild(n);
          n.querySelector('.nf-x').onclick = () => n.remove();
          setTimeout(() => n.remove(), 4200);
        },
      });

      console.log('ðŸŽ¯ startCheckout executado com sucesso');
    } catch (error) {
      console.error('âŒ Erro ao executar startCheckout:', error);
      svc = null;
    }

    if (svc && typeof svc === 'object') {
      window.checkoutService = svc;
      window.machineService = svc;
      console.log('âœ… Checkout Machine ready!');
      console.log('ðŸŽ¯ Estado atual:', svc.state);
    }

    // Setup validation
    function setupRealTimeValidation() {
      const walletField = document.getElementById('wallet');
      const valorField = document.getElementById('valor');
      const cryptoAmountField = document.getElementById('crypto-amount');
      const cryptoToField = document.getElementById('crypto-to');

      if (walletField) {
        walletField.addEventListener('input', function () {
          const value = this.value.trim();
          const isValid = value.length > 0 && value.startsWith('0x') && value.length === 42;

          this.classList.toggle('valid', isValid);
          this.classList.toggle('invalid', !isValid && value.length > 0);

          let errorMsg = this.parentNode.querySelector('.field-error');
          if (!errorMsg && !isValid && value.length > 0) {
            errorMsg = document.createElement('div');
            errorMsg.className = 'field-error';
            errorMsg.textContent = 'Wallet deve ser um endereÃ§o Ethereum vÃ¡lido (0x...)';
            this.parentNode.appendChild(errorMsg);
          } else if (errorMsg && isValid) {
            errorMsg.remove();
          }
        });
      }

      if (valorField) {
        valorField.addEventListener('input', function () {
          const value = parseFloat(this.value);
          const isValid = value > 0;

          this.classList.toggle('valid', isValid);
          this.classList.toggle('invalid', !isValid && this.value.length > 0);

          let errorMsg = this.parentNode.querySelector('.field-error');
          if (!errorMsg && !isValid && this.value.length > 0) {
            errorMsg = document.createElement('div');
            errorMsg.className = 'field-error';
            errorMsg.textContent = 'Valor deve ser maior que zero';
            this.parentNode.appendChild(errorMsg);
          } else if (errorMsg && isValid) {
            errorMsg.remove();
          }
        });
      }

      if (cryptoAmountField) {
        cryptoAmountField.addEventListener('input', function () {
          const value = parseFloat(this.value);
          const isValid = value > 0;
          this.classList.toggle('valid', isValid);
          this.classList.toggle('invalid', !isValid && this.value.length > 0);
        });
      }

      if (cryptoToField) {
        cryptoToField.addEventListener('input', function () {
          const value = this.value.trim();
          const isValid = value.length > 0 && value.startsWith('0x') && value.length === 42;
          this.classList.toggle('valid', isValid);
          this.classList.toggle('invalid', !isValid && value.length > 0);
        });
      }
    }

    function setupKeyboardNavigation() {
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && e.target.matches('input')) {
          e.preventDefault();

          const currentForm = e.target.closest('form');
          if (currentForm) {
            const inputs = Array.from(currentForm.querySelectorAll('input'));
            const currentIndex = inputs.indexOf(e.target);

            if (currentIndex < inputs.length - 1) {
              inputs[currentIndex + 1].focus();
            } else {
              currentForm.requestSubmit();
            }
          }
        }

        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          const inputs = Array.from(document.querySelectorAll('input:not([type="hidden"])'));
          const currentIndex = inputs.indexOf(document.activeElement);

          if (e.key === 'ArrowDown' && currentIndex < inputs.length - 1) {
            inputs[currentIndex + 1].focus();
          } else if (e.key === 'ArrowUp' && currentIndex > 0) {
            inputs[currentIndex - 1].focus();
          }
        }
      });
    }

    // Preencher ID da transaÃ§Ã£o automaticamente
    const idField = document.getElementById('id_transacao');
    if (idField) {
      idField.value = `pix_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
    }

    // Auto-focus no primeiro campo
    const walletField = document.getElementById('wallet');
    if (walletField) walletField.focus();

    // Setup
    setupRealTimeValidation();
    setupKeyboardNavigation();
  });
</script>
