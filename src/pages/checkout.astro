---
import CheckoutLayout from '../layouts/CheckoutLayout.astro';
import CheckoutHeader from '../components/checkout/CheckoutHeader.astro';
import ModeChooser from '../components/checkout/ModeChooser.astro';
import PixForm from '../components/checkout/PixForm.astro';
import CryptoForm from '../components/checkout/CryptoForm.astro';
---

<CheckoutLayout>
  <main class="checkout-main">
    <CheckoutHeader />
    
    <ModeChooser />

    <section class="flow-step" data-state="details" id="step-details" hidden>
      <PixForm />
      <CryptoForm />
    </section>

    <section class="flow-step" data-state="confirm" id="step-confirm" hidden>
      <div class="card success">
        <h3>Sucesso!</h3>
        <p>Seu pagamento est√° sendo processado no NŒû√ò PROTOCOL.</p>
        <div style="margin-top: 24px;">
          <button class="primary" data-action="reset">Novo Pagamento</button>
        </div>
      </div>
    </section>

    <footer style="text-align: center; margin-top: 32px; opacity: 0.5; font-size: 12px;">
      <p>&copy; 2026 FLOWPay Sovereign Systems</p>
    </footer>
  </main>
</CheckoutLayout>

<script type="module">
  import { startCheckout } from '/assets/js/navigation-flow.machine.js';

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Initializing FLOWPay Sovereign UI...');

    // Load copy
    let copy = {};
    try {
      const res = await fetch('/ui.copy.pt.json', { cache: 'no-store' });
      if (res.ok) copy = await res.json();
    } catch (error) {
      console.warn('‚ö†Ô∏è Copy loading failed');
    }

    let svc = startCheckout({
      copy,
      services: {
        createPix: async (ctx, p) => {
          const response = await fetch('/api/create-charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(p),
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || 'Erro ao criar PIX');
          }
          return await response.json();
        },
        submitCrypto: (ctx, p) => Promise.resolve({ success: true, hash: '0x...' }),
        connect: () => window.connectWallet?.(),
        disconnect: () => window.disconnectWallet?.(),
      },
      onToast: (msg, type) => {
        const holder = document.getElementById('nf-toasts');
        const n = document.createElement('div');
        n.className = `nf-toast is-${type || 'info'}`;
        n.innerHTML = `<span>${msg}</span><button class="nf-x" onclick="this.parentElement.remove()">√ó</button>`;
        holder.appendChild(n);
        setTimeout(() => n.remove(), 5000);
      },
    });

    if (svc) {
      window.checkoutService = svc;
      // Progress Sync
      svc.subscribe(state => {
        const fill = document.getElementById('nf-fill');
        if (fill) {
          if (state.matches('choose')) fill.style.width = '33%';
          if (state.matches('details')) fill.style.width = '66%';
          if (state.matches('confirm')) fill.style.width = '100%';
        }
      });
    }

    // ID Transa√ß√£o
    const idField = document.getElementById('id_transacao');
    if (idField) {
      idField.value = `pix_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`;
    }
  });
</script>
