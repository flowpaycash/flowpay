---
import CheckoutLayout from '../layouts/CheckoutLayout.astro';
import CheckoutHeader from '../components/checkout/CheckoutHeader.astro';
import ModeChooser from '../components/checkout/ModeChooser.astro';
import PixForm from '../components/checkout/PixForm.astro';
import CryptoForm from '../components/checkout/CryptoForm.astro';
import StatusStepper from '../components/checkout/StatusStepper.astro';
---

<CheckoutLayout>
  <main class="checkout-main">
    <CheckoutHeader />
    
    <ModeChooser />

    <section class="flow-step" data-state="details" id="step-details" hidden>
      <PixForm />
      <CryptoForm />
    </section>

    <section class="flow-step" data-state="confirm" id="step-confirm" hidden>
      <StatusStepper />
      
      <div id="payment-area" style="text-align: center; margin-top: 2rem;">
        <!-- QR Code Container -->
        <div id="qr-container">
            <p id="qr-instruction" style="opacity: 0.8; margin-bottom: 1rem;">Escaneie o QR Code para pagar</p>
            <div style="background: white; padding: 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">
                <img id="qr-image" src="" alt="QR Code PIX" style="width: 200px; height: 200px; display: block;" />
            </div>
            <div style="margin-top: 1rem;">
                <input id="br-code-copy" readonly style="width: 100%; max-width: 300px; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;" />
                <button class="text" onclick="const e=document.getElementById('br-code-copy');e.select();document.execCommand('copy');alert('C칩digo copiado!')" style="margin-top: 8px;">Copiar C칩digo Pix</button>
            </div>
        </div>

        <!-- Processing State -->
        <div id="processing-state" hidden>
            <h3 class="gradient-text pulse-anim" style="font-size: 1.5rem;">Processando...</h3>
            <p style="opacity: 0.7;">A Smart Factory est치 validando sua transa칞칚o.</p>
        </div>

        <!-- Final Success -->
        <div id="success-state" hidden>
             <h3 style="color: #4ade80;">Ativo Emitido!</h3>
             <p>Sucesso. O ativo j치 est치 na sua carteira.</p>
             <div style="margin-top: 24px;">
               <button class="primary" data-action="reset">Novo Pagamento</button>
             </div>
        </div>
      </div>
    </section>

    <footer style="text-align: center; margin-top: 32px; opacity: 0.5; font-size: 12px;">
      <p>&copy; 2026 FlowPay Sovereign Systems</p>
    </footer>
  </main>
</CheckoutLayout>

<script type="module">
  import { startCheckout } from '/assets/js/navigation-flow.machine.js';

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('游 Initializing FLOWPay Sovereign UI...');
    
    // Polling Control
    let pollInterval = null;
    const pollingArea = {
        qr: document.getElementById('qr-container'),
        proc: document.getElementById('processing-state'),
        success: document.getElementById('success-state'),
        qrImg: document.getElementById('qr-image'),
        brCopy: document.getElementById('br-code-copy'),
        steps: document.querySelectorAll('.step')
    };

    function updateStepper(stepIndex) {
        pollingArea.steps.forEach((s, i) => {
            const stepNum = parseInt(s.dataset.step);
            s.classList.toggle('done', stepNum < stepIndex);
            s.classList.toggle('active', stepNum === stepIndex);
        });
    }

    // Load copy
    let copy = {};
    try {
      const res = await fetch('/ui.copy.pt.json', { cache: 'no-store' });
      if (res.ok) copy = await res.json();
    } catch (error) {
      console.warn('丘멆잺 Copy loading failed');
    }

    let svc = startCheckout({
      copy,
      services: {
        createPix: async (ctx, p) => {
          const response = await fetch('/api/create-charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(p),
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || 'Erro ao criar PIX');
          }
          return await response.json();
        },
        submitCrypto: (ctx, p) => Promise.resolve({ success: true, hash: '0x...' }),
        connect: () => window.connectWallet?.(),
        disconnect: () => window.disconnectWallet?.(),
      },
      onToast: (msg, type) => {
        const holder = document.getElementById('nf-toasts');
        // Simple toast fallback if holder missing (it is missing in previous file view, let's look at layout?)
        // Assuming layout has it or we just log.
        console.log(`Toast: ${msg}`); 
      },
    });

    if (svc) {
      window.checkoutService = svc;
      // Progress Sync & Polling
      svc.subscribe(state => {
        const fill = document.getElementById('nf-fill');
        if (fill) {
          if (state.matches('choose')) fill.style.width = '33%';
          if (state.matches('details')) fill.style.width = '66%';
          if (state.matches('confirm')) fill.style.width = '100%';
        }

        // Logic for Confirm State
        if (state.matches('confirm')) {
            const data = state.context.lastResult;
            
            // Render QR if new
            if (data && data.success && data.pix_data) {
                // Show QR, Hide others
                pollingArea.qr.hidden = false;
                pollingArea.proc.hidden = true;
                pollingArea.success.hidden = true;
                
                pollingArea.qrImg.src = data.pix_data.qr_code;
                pollingArea.brCopy.value = data.pix_data.br_code;
                
                updateStepper(1); // Step 1 Active

                // Start Polling
                if (!pollInterval) {
                    console.log('游니 Starting Polling for Charge:', data.id_transacao);
                    pollInterval = setInterval(async () => {
                        try {
                            const res = await fetch(`/api/charge/${data.id_transacao}`);
                            const statusData = await res.json();
                            
                            if (statusData.status === 'PIX_PAID' || statusData.status === 'PENDING_REVIEW') {
                                // Step 2: Factory
                                pollingArea.qr.hidden = true;
                                pollingArea.proc.hidden = false;
                                updateStepper(2);
                                
                                // Check bridge status for step 3
                                if (statusData.bridge_status === 'SENT') {
                                    updateStepper(3);
                                }
                            } 
                            else if (statusData.status === 'COMPLETED' || statusData.tx_hash) {
                                // Step 4: Done
                                pollingArea.proc.hidden = true;
                                pollingArea.success.hidden = false;
                                updateStepper(4);
                                
                                clearInterval(pollInterval);
                                pollInterval = null;
                            }
                        } catch (e) { console.warn('Poll error', e); }
                    }, 3000);
                }
            }
        } else {
            // Cleanup if leaving confirm
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
      });
    }

    // Auto-restore logic is in machine boot (startCheckout) now, but form specifics are in PixForm.
    // ID Transaction logic moved to form submission flow usually, but we keep the random ID for now if needed.
  });
</script>
